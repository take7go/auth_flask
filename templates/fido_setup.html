<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>FIDO登録</title>
</head>
<body>
  <h1>FIDO認証器登録</h1>

  <button onclick="fidoSetup()">認証器を登録する</button>

    <script>
    function base64urlToUint8Array(base64url) {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = (base64url + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
    
      const raw = atob(base64);
      return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
    }

    function bufferToBase64url(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = "";
      bytes.forEach(b => binary += String.fromCharCode(b));
      return btoa(binary)
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
    }

    async function fidoSetup() {
      try {
        const res = await fetch("/fido/setup/begin");
        if (!res.ok) throw new Error("begin failed");

        const options = await res.json();

        options.challenge = base64urlToUint8Array(options.challenge);
        options.user.id = base64urlToUint8Array(options.user.id);

        const cred = await navigator.credentials.create({
          publicKey: options
        });

        // ★ ここが重要：JSON用に変換
        const data = {
          id: cred.id,
          rawId: bufferToBase64url(cred.rawId),
          type: cred.type,
          response: {
            attestationObject: bufferToBase64url(
              cred.response.attestationObject
            ),
            clientDataJSON: bufferToBase64url(
              cred.response.clientDataJSON
            ),
          }
        };

        const result = await fetch("/fido/setup/complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (!result.ok) throw new Error("complete failed");

        alert("登録完了");
        location.href = "/";
      } catch (e) {
        alert("登録に失敗しました: " + e.message);
        console.error(e);
      }
    }
    </script>
</body>
</html>
